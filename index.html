<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ê≥∞ËØ≠Â≠¶‰π†Âä©Êâã</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #000;
            color: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            overflow: hidden;
        }
        
        /* Navigation */
        #main-nav {
            width: 100%;
            background: #111;
            padding: 10px 0;
            display: flex;
            justify-content: center;
            gap: 20px;
            border-bottom: 1px solid #333;
            z-index: 100;
        }
        .nav-btn {
            background: transparent;
            color: #888;
            border: none;
            font-size: 16px;
            cursor: pointer;
            padding: 5px 10px;
            font-weight: bold;
        }
        .nav-btn.active {
            color: #fff;
            border-bottom: 2px solid #0070f3;
        }
        
        /* Views */
        .view-section {
            width: 100%;
            height: calc(100vh - 50px);
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-y: auto;
            position: relative;
        }
        
        /* Player View Styles */
        #player-container {
            width: 90%;
            max-width: 800px;
            aspect-ratio: 16/9;
            background: #111;
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            overflow: hidden;
            margin-top: 20px;
        }
        video {
            width: 100%;
            height: 100%;
            object-fit: contain;
            transition: filter 0.3s;
        }
        video.blur {
            filter: blur(20px);
        }
        #controls-hint {
            margin-top: 20px;
            text-align: center;
            color: #888;
            width: 100%;
            max-width: 800px;
        }
        #current-info {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.5);
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 14px;
            pointer-events: none;
            z-index: 10;
        }
        #group-selector {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: 1px solid #555;
            padding: 5px;
            border-radius: 4px;
            z-index: 10;
        }
        .key {
            display: inline-block;
            background: #333;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            margin: 0 2px;
            border: 1px solid #555;
        }
        
        /* Quiz UI */
        #quiz-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 20;
        }
        .quiz-active #quiz-overlay {
            display: flex;
        }
        .quiz-title {
            font-size: 24px;
            margin-bottom: 20px;
            color: #4CAF50;
        }
        .quiz-question {
            font-size: 18px;
            margin-bottom: 20px;
            text-align: center;
        }
        .quiz-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            width: 80%;
        }
        .quiz-btn {
            background: #333;
            color: white;
            border: 1px solid #555;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.2s;
        }
        .quiz-btn:hover {
            background: #444;
        }
        .quiz-btn.correct {
            background: #2e7d32;
            border-color: #4CAF50;
        }
        .quiz-btn.wrong {
            background: #c62828;
            border-color: #ef5350;
        }
        
        /* Mobile controls */
        .mobile-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 10px;
        }
        .control-btn {
            background: #333;
            color: #fff;
            border: 1px solid #555;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 16px;
            cursor: pointer;
            touch-action: manipulation;
        }
        .control-btn:active {
            background: #555;
        }
        .main-btn {
            background: #0070f3;
            border-color: #0070f3;
            font-weight: bold;
        }
        .main-btn:active {
            background: #0051a2;
        }
        
        /* Lessons View Styles */
        .lesson-container {
            width: 90%;
            max-width: 800px;
            padding: 20px 0;
        }
        
        /* Flashcard Styles */
        .flashcard-container {
            width: 100%;
            display: flex;
            justify-content: center;
            perspective: 1000px;
            margin-top: 20px;
        }
        .flashcard {
            width: 80%;
            max-width: 300px;
            aspect-ratio: 3/4;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s;
            cursor: pointer;
        }
        .flashcard.flipped {
            transform: rotateY(180deg);
        }
        .flashcard-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            background: #1a1a1a;
            border: 2px solid #333;
            padding: 10px; /* Reduced padding for mobile */
            box-sizing: border-box;
            text-align: center;
        }
        .flashcard-front {
            z-index: 2;
        }
        .flashcard-back {
            transform: rotateY(180deg);
            background: #222;
            border-color: #0070f3;
        }
        
        .card-thai {
            font-size: 32px;
            font-weight: bold;
            color: #fff;
            margin-bottom: 15px;
            word-break: break-word; /* Prevent overflow */
        }
        .card-phonetic {
            font-size: 16px;
            color: #aaa;
            font-family: monospace;
            margin-bottom: 15px;
            word-break: break-word;
        }
        .card-chinese {
            font-size: 24px;
            color: #4CAF50;
            font-weight: bold;
            margin-bottom: 15px; /* Add margin */
        }
        .card-hint {
            position: absolute;
            bottom: 15px;
            font-size: 12px;
            color: #666;
        }
        
        /* Flashcard Controls */
        .card-controls {
            display: flex;
            gap: 20px;
            margin-top: 30px;
            justify-content: center;
            width: 100%;
        }
        .nav-arrow {
            background: #333;
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        .nav-arrow:active {
            background: #555;
        }
        .nav-arrow:disabled {
            opacity: 0.3;
            cursor: default;
        }
        
        .lesson-card {
            background: #1a1a1a;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: transform 0.2s, background 0.2s;
            border: 1px solid #333;
        }
        .lesson-card:hover {
            transform: translateY(-2px);
            background: #222;
            border-color: #0070f3;
        }
        .lesson-header {
            width: 90%;
            max-width: 800px;
            display: flex;
            align-items: center;
            padding: 20px 0;
            gap: 20px;
        }
        .lesson-content {
            width: 90%;
            max-width: 800px;
            padding-bottom: 50px;
        }
        .vocab-item {
            background: #1a1a1a;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid #0070f3;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .vocab-row {
            display: grid;
            grid-template-columns: 1fr auto;
            align-items: center;
            gap: 10px;
        }
        .vocab-thai {
            font-size: 20px;
            font-weight: bold;
            color: #fff;
        }
        .vocab-phonetic {
            color: #aaa;
            font-family: monospace;
        }
        .vocab-chinese {
            color: #4CAF50;
            font-size: 16px;
        }
        .action-btn {
            background: #333;
            border: 1px solid #555;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .action-btn:hover {
            background: #444;
        }
        
        /* PDF Modal */
        #pdf-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 200;
            flex-direction: column;
        }
        #pdf-canvas-container {
            width: 90%;
            height: 80%;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: auto;
        }
        #pdf-canvas {
            max-width: 100%;
            max-height: 100%;
        }
        .close-modal {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #fff;
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
        }
        
        /* Mobile adjustments */
        @media (max-width: 768px) {
            .flashcard {
                 max-width: 300px; /* Even smaller on mobile */
            }
            .card-thai {
                font-size: 28px; /* Reduced from 32px */
            }
            .card-chinese {
                font-size: 22px; /* Reduced from 24px */
            }
            .mobile-controls {
                display: flex;
            }
            .desktop-hint {
                display: none;
            }
            .vocab-item {
                flex-direction: column;
                align-items: flex-start;
            }
            .vocab-row {
                display: grid;
            }
        }

        @media (min-width: 768px) {
            .mobile-controls {
                display: none;
            }
            .desktop-hint {
                display: block;
            }
            .vocab-item {
                flex-direction: row;
                align-items: center;
                justify-content: space-between;
            }
            .vocab-row {
                display: block;
            }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <!-- PDF Modal -->
<div id="pdf-modal">
    <button class="close-modal" onclick="closePdfModal()">ÂÖ≥Èó≠</button>
    <div id="pdf-canvas-container">
        <canvas id="pdf-canvas"></canvas>
    </div>
</div>

<script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
</head>
<body>

<nav id="main-nav">
    <button id="nav-player" class="nav-btn active" onclick="switchView('player')">100Âè•Ê¥óËÑë</button>
    <button id="nav-lessons" class="nav-btn" onclick="switchView('lessons')">ÊØèÊó•ËØæÁ®ã</button>
</nav>

<!-- View: Player -->
<div id="view-player" class="view-section">
    <div id="player-container">
        <video id="video-player" playsinline></video>
        <div id="current-info">Âä†ËΩΩ‰∏≠...</div>
        <select id="group-selector" onchange="changeGroup(this.value)">
            <!-- Options populated by JS -->
        </select>
    </div>

    <div id="controls-hint">
        <p class="desktop-hint"><span class="key">Á©∫Ê†º</span> Êí≠Êîæ/ÊöÇÂÅú &nbsp;&nbsp; <span class="key">‚Üê</span> ‰∏ä‰∏Ä‰∏™ &nbsp;&nbsp; <span class="key">‚Üí</span> ‰∏ã‰∏Ä‰∏™</p>
        <div class="mobile-controls">
            <button class="control-btn" onclick="prevVideo()">‰∏ä‰∏ÄÂè•</button>
            <button class="control-btn main-btn" onclick="togglePlay()">Êí≠Êîæ/ÊöÇÂÅú</button>
            <button class="control-btn" onclick="nextVideo()">‰∏ã‰∏ÄÂè•</button>
        </div>
        <p id="status-msg">ÂáÜÂ§áÂ∞±Áª™</p>
    </div>
</div>

<!-- View: Lessons List -->
<div id="view-lessons" class="view-section" style="display:none;">
    <div class="lesson-container">
        <h2>ËØæÁ®ãÂàóË°®</h2>
        <div id="lesson-list">
            <div class="lesson-card" onclick="openLesson('day1')">
                <h3>Day 1</h3>
                <p>ÈóÆÂÄô‰∏é‰ªãÁªç</p>
            </div>
            <div class="lesson-card" onclick="openLesson('day2')">
                <h3>Day 2</h3>
                <p>Êó•Â∏∏ËØçÊ±á‰∏éÂè•Â≠êÁªÉ‰π†</p>
            </div>
            <!-- Future lessons can be added here -->
        </div>
    </div>
</div>

<!-- View: Lesson Detail -->
<div id="view-lesson-detail" class="view-section" style="display:none;">
    <div class="lesson-header">
        <button class="control-btn" onclick="switchView('lessons')">‚Üê ËøîÂõûÂàóË°®</button>
        <h2 id="lesson-title">ËØæÁ®ãÂÜÖÂÆπ</h2>
        <div style="margin-left: auto; display: flex; gap: 10px;">
            <select id="lesson-group-selector" onchange="changeLessonGroup(this.value)" style="padding: 5px; border-radius: 4px; background: #333; color: white; border: 1px solid #555;">
                <!-- Populated by JS -->
            </select>
            <button class="control-btn main-btn" onclick="startLessonAutoPlay()">ÂºÄÂßãÂ≠¶‰π†</button>
        </div>
    </div>
    <div id="lesson-content" class="lesson-content">
        <!-- Content injected by JS -->
        <p style="text-align:center;">Âä†ËΩΩ‰∏≠...</p>
    </div>
</div>

<!-- Quiz Overlay (Moved to body level) -->
<div id="quiz-overlay">
    <div class="quiz-title">Èò∂ÊÆµÊµãËØï</div>
    <div class="quiz-question" id="quiz-question-text">Âê¨ÂΩïÈü≥ÔºåÈÄâÊã©Ê≠£Á°ÆÁöÑ‰∏≠ÊñáÂê´‰πâ</div>
    <div class="quiz-options" id="quiz-options">
        <!-- Buttons injected by JS -->
    </div>
    <div id="quiz-result" style="margin-top: 20px; font-weight: bold;"></div>
    <div style="margin-top: 20px; display: flex; gap: 10px;">
         <button id="quiz-skip-btn" class="control-btn" onclick="closeQuiz()">Ë∑≥ËøáÊµãËØï</button>
         <button id="quiz-next-btn" class="control-btn main-btn" style="display:none;" onclick="nextQuizQuestion()">ÁªßÁª≠ÊµãËØï</button>
         <button id="quiz-close-btn" class="control-btn" style="display:none;" onclick="closeQuiz()">ÁªìÊùüÊµãËØï</button>
    </div>
</div>

<script>
    // --- View Navigation ---
    function switchView(viewName) {
        // Hide all views
        document.querySelectorAll('.view-section').forEach(el => el.style.display = 'none');
        document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
        
        // Show selected view
        document.getElementById(`view-${viewName}`).style.display = viewName === 'player' ? 'flex' : 'flex';
        // Adjust display for specific layout if needed
        if(viewName === 'lessons' || viewName === 'lesson-detail') {
             document.getElementById(`view-${viewName}`).style.display = 'flex';
        }
        
        // Update nav
        if (viewName === 'lesson-detail') {
            document.getElementById('nav-lessons').classList.add('active');
        } else {
            document.getElementById(`nav-${viewName}`).classList.add('active');
        }
        
        // Pause video if leaving player
        if (viewName !== 'player' && !videoPlayer.paused) {
            videoPlayer.pause();
        }
    }

    // --- Lesson Logic ---
    let currentPdfDoc = null;
    let pdfDocs = {}; // Cache for loaded PDFs

    let currentLessonItems = [];
    let currentLessonGroupIndex = 0;
    const LESSON_GROUP_SIZE = 5;
    
    // Auto Play State
    let isLessonAutoPlaying = false;
    let currentLessonItemIndex = 0; // Index within the group (0-4)
    let currentLessonItemLoop = 0;
    const LESSON_ITEM_LOOPS = 5;
    let autoPlayTimeout = null;

    function openLesson(lessonId) {
        switchView('lesson-detail');
        
        let title = lessonId;
        if (lessonId === 'day1') title = 'Day 1: ÈóÆÂÄô‰∏é‰ªãÁªç';
        if (lessonId === 'day2') title = 'Day 2: Êó•Â∏∏ËØçÊ±á‰∏éÂè•Â≠ê';
        document.getElementById('lesson-title').textContent = title;
        
        const contentDiv = document.getElementById('lesson-content');
        contentDiv.innerHTML = '<p style="text-align:center;">Âä†ËΩΩ‰∏≠...</p>';
        
        // Stop any previous autoplay
        stopLessonAutoPlay();
        
        // PDF Loading Logic
        const pdfMap = {
            'day1': 'kejian/Day%201.pdf',
            'day2': 'kejian/Day%202.pdf'
        };
        
        currentPdfDoc = null; // Reset current doc first
        
        if (pdfMap[lessonId]) {
            if (pdfDocs[lessonId]) {
                currentPdfDoc = pdfDocs[lessonId];
                console.log("PDF Loaded from cache");
            } else {
                pdfjsLib.getDocument(pdfMap[lessonId]).promise.then(doc => {
                    pdfDocs[lessonId] = doc;
                    currentPdfDoc = doc;
                    console.log("PDF Loaded");
                }).catch(err => console.error("PDF Load Error", err));
            }
        }
        
        fetch(`data/${lessonId}.json`)
            .then(res => res.json())
            .then(data => {
                currentLessonItems = data;
                initLessonGroups();
                loadLessonGroup(0);
            })
            .catch(err => {
                contentDiv.innerHTML = '<p style="text-align:center; color:red;">Âä†ËΩΩÂ§±Ë¥•</p>';
                console.error(err);
            });
    }
    
    function initLessonGroups() {
        const selector = document.getElementById('lesson-group-selector');
        selector.innerHTML = '';
        const totalGroups = Math.ceil(currentLessonItems.length / LESSON_GROUP_SIZE);
        
        for (let i = 0; i < totalGroups; i++) {
            const start = i * LESSON_GROUP_SIZE + 1;
            const end = Math.min((i + 1) * LESSON_GROUP_SIZE, currentLessonItems.length);
            const option = document.createElement('option');
            option.value = i;
            option.textContent = `Á¨¨ ${i + 1} ÁªÑ (${start}-${end})`;
            selector.appendChild(option);
        }
    }
    
    function changeLessonGroup(index) {
        stopLessonAutoPlay();
        loadLessonGroup(parseInt(index));
    }
    
    function loadLessonGroup(groupIndex) {
        currentLessonGroupIndex = groupIndex;
        document.getElementById('lesson-group-selector').value = groupIndex;
        
        // Reset Auto Play
        stopLessonAutoPlay();
        
        // Reset Flashcard view to start
        currentLessonItemIndex = 0; // Reuse this var for card index
        
        renderFlashcardView();
    }
    
    function renderFlashcardView() {
        const container = document.getElementById('lesson-content');
        container.innerHTML = '';
        
        const start = currentLessonGroupIndex * LESSON_GROUP_SIZE;
        const end = Math.min((currentLessonGroupIndex + 1) * LESSON_GROUP_SIZE, currentLessonItems.length);
        const groupItems = currentLessonItems.slice(start, end);
        
        if (groupItems.length === 0) return;
        
        // Ensure index is valid for this group
        if (currentLessonItemIndex >= groupItems.length) currentLessonItemIndex = 0;
        
        const item = groupItems[currentLessonItemIndex];
        const safeThai = item.thai.replace(/'/g, "\\'");
        const safeChinese = item.chinese.replace(/'/g, "\\'");
        
        // Flashcard HTML
        const cardHTML = `
            <div class="flashcard-container">
                <div class="flashcard" onclick="flipCard(this)">
                    <div class="flashcard-face flashcard-front">
                        <div class="card-thai">${item.thai}</div>
                        <button class="action-btn" onclick="event.stopPropagation(); playAudio('${safeThai}', 'th-TH')">üîä Êí≠ÊîæÊ≥∞ËØ≠</button>
                        <div class="card-hint">ÁÇπÂáªÂç°ÁâáÊü•Áúã‰∏≠Êñá</div>
                    </div>
                    <div class="flashcard-face flashcard-back">
                        <div class="card-phonetic">${item.phonetic}</div>
                        <div class="card-chinese">${item.chinese}</div>
                        <button class="action-btn" onclick="event.stopPropagation(); playAudio('${safeChinese}', 'zh-CN')">üîä Êí≠Êîæ‰∏≠Êñá</button>
                        ${item.page ? `<div style="margin-top:15px;"><button class="action-btn" onclick="event.stopPropagation(); viewPdfPage(${item.page})">üìÑ Êü•ÁúãËØæ‰ª∂</button></div>` : ''}
                    </div>
                </div>
            </div>
            
            <div class="card-controls">
                <button class="nav-arrow" onclick="prevFlashcard()" ${currentLessonItemIndex === 0 ? 'disabled' : ''}>‚Üê</button>
                <div style="display:flex; align-items:center; color:#888;">${currentLessonItemIndex + 1} / ${groupItems.length}</div>
                <button class="nav-arrow" onclick="nextFlashcard()" ${currentLessonItemIndex === groupItems.length - 1 ? 'disabled' : ''}>‚Üí</button>
            </div>
        `;
        
        container.innerHTML = cardHTML;
    }
    
    function flipCard(card) {
        card.classList.toggle('flipped');
    }
    
    function prevFlashcard() {
        if (currentLessonItemIndex > 0) {
            currentLessonItemIndex--;
            renderFlashcardView();
        }
    }
    
    function nextFlashcard() {
        const start = currentLessonGroupIndex * LESSON_GROUP_SIZE;
        const groupItems = currentLessonItems.slice(start, Math.min((currentLessonGroupIndex + 1) * LESSON_GROUP_SIZE, currentLessonItems.length));
        
        if (currentLessonItemIndex < groupItems.length - 1) {
            currentLessonItemIndex++;
            renderFlashcardView();
        } else {
            // End of group, maybe suggest quiz?
            // For now just stay on last card
        }
    }
    
    // Original list render function (now replaced/unused but keeping logic ref if needed)
    // function renderLessonContent(items) { ... }

    function playAudio(text, lang, onEndCallback) {
        // Try Web Speech API first
        if ('speechSynthesis' in window) {
            window.speechSynthesis.cancel();
            
            // Check for voices
            const voices = window.speechSynthesis.getVoices();
            const thaiVoice = voices.find(v => v.lang === 'th-TH' || v.lang === 'th');
            
            // If requesting Thai but no Thai voice, fallback to Google TTS immediately
            if (lang.startsWith('th') && !thaiVoice && voices.length > 0) {
                console.warn("No Thai voice found, using fallback.");
                playAudioFallback(text, lang, onEndCallback);
                return;
            }
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = lang;
            if (thaiVoice) utterance.voice = thaiVoice;
            
            utterance.onend = () => {
                if (onEndCallback) onEndCallback();
            };
            
            utterance.onerror = (e) => {
                console.error("SpeechSynthesis Error:", e);
                // If error, try fallback
                playAudioFallback(text, lang, onEndCallback);
            };
            
            window.speechSynthesis.speak(utterance);
            
            if (window.speechSynthesis.paused) {
                window.speechSynthesis.resume();
            }
            
        } else {
            playAudioFallback(text, lang, onEndCallback);
        }
    }
    
    function playAudioFallback(text, lang, onEndCallback) {
        // Fallback to Google Translate TTS (unofficial but works for simple testing)
        // Note: 'zh-CN' for Chinese, 'th' for Thai
        const targetLang = lang === 'zh-CN' ? 'zh-CN' : 'th';
        const url = `https://translate.google.com/translate_tts?ie=UTF-8&q=${encodeURIComponent(text)}&tl=${targetLang}&client=tw-ob`;
        
        const audio = new Audio(url);
        
        audio.onended = () => {
            if (onEndCallback) onEndCallback();
        };
        
        audio.onerror = (e) => {
            console.error("Audio Fallback Error:", e);
            alert("Êó†Ê≥ïÊí≠ÊîæÈü≥È¢ëÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúÊàñËÆæÂ§áËÆæÁΩÆ");
            if (onEndCallback) onEndCallback();
        };
        
        audio.play().catch(e => {
            console.error("Audio Play Error:", e);
            alert("Êí≠ÊîæÂ§±Ë¥•ÔºåËØ∑ÁÇπÂáªÈ°µÈù¢Ëß¶ÂèëÈü≥È¢ë");
        });
    }

    // Ensure voices are loaded (async on some browsers)
    if ('speechSynthesis' in window) {
        window.speechSynthesis.onvoiceschanged = () => {
            console.log("Voices loaded:", window.speechSynthesis.getVoices().length);
        };
    }
    
    // --- Lesson Auto Play Logic ---
    
    function startLessonAutoPlay() {
        if (isLessonAutoPlaying) {
            stopLessonAutoPlay();
            return;
        }
        
        // Mobile iOS requirement: Audio must be triggered by user interaction first.
        // We can play a silent sound or just start speaking immediately since this function IS called by a click event.
        if ('speechSynthesis' in window) {
             window.speechSynthesis.cancel();
             // Just a dummy speak to 'unlock' audio on some devices if needed, though usually direct call works.
        }
        
        const btn = document.querySelector('#lesson-group-selector + button');
        btn.textContent = "ÂÅúÊ≠¢Â≠¶‰π†";
        btn.classList.add('wrong'); // Red color to indicate stop action
        
        isLessonAutoPlaying = true;
        currentLessonItemIndex = 0;
        currentLessonItemLoop = 0;
        
        playNextLessonItem();
    }
    
    function stopLessonAutoPlay() {
        isLessonAutoPlaying = false;
        window.speechSynthesis.cancel();
        clearTimeout(autoPlayTimeout);
        
        const btn = document.querySelector('#lesson-group-selector + button');
        if (btn) {
            btn.textContent = "ÂºÄÂßãÂ≠¶‰π†";
            btn.classList.remove('wrong');
        }
        
        // Remove highlights (No longer needed for cards, but keep generic cleanup if needed)
    }
    
    function playNextLessonItem() {
        if (!isLessonAutoPlaying) return;
        
        const start = currentLessonGroupIndex * LESSON_GROUP_SIZE;
        const groupItems = currentLessonItems.slice(start, Math.min((currentLessonGroupIndex + 1) * LESSON_GROUP_SIZE, currentLessonItems.length));
        
        // Check if group finished
        if (currentLessonItemIndex >= groupItems.length) {
            // Group finished -> Start Quiz
            stopLessonAutoPlay();
            startLessonQuiz(true); // Pass true to indicate it's from auto-play
            return;
        }
        
        // Update view to current card
        renderFlashcardView();
        
        const item = groupItems[currentLessonItemIndex];
        const currentCard = document.querySelector('.flashcard');
        
        // Play audio (Thai only for drill? Or Thai then Chinese? Usually Drill = Target Language)
        playAudio(item.thai, 'th-TH', () => {
            currentLessonItemLoop++;
            if (currentLessonItemLoop < LESSON_ITEM_LOOPS) {
                // Delay slightly between loops
                autoPlayTimeout = setTimeout(playNextLessonItem, 500);
            } else {
                // Last loop finished
                
                // 1. Flip to back (Chinese)
                if (currentCard && !currentCard.classList.contains('flipped')) {
                    currentCard.classList.add('flipped');
                }
                
                // 2. Wait 1 second (user reads Chinese)
                // 3. Move to next item
                autoPlayTimeout = setTimeout(() => {
                    currentLessonItemIndex++;
                    currentLessonItemLoop = 0;
                    playNextLessonItem();
                }, 1000); // 1 second delay
            }
        });
    }
    
    function viewPdfPage(pageNum) {
        if (!currentPdfDoc) {
            alert("ËØæ‰ª∂Ê≠£Âú®Âä†ËΩΩÔºåËØ∑Á®çÂêéÂÜçËØï");
            return;
        }
        
        document.getElementById('pdf-modal').style.display = 'flex';
        
        currentPdfDoc.getPage(pageNum).then(function(page) {
            const canvas = document.getElementById('pdf-canvas');
            const ctx = canvas.getContext('2d');
            
            // Adjust scale based on screen width
            const scale = window.innerWidth < 768 ? 0.6 : 1.0;
            const viewport = page.getViewport({scale: scale});

            canvas.height = viewport.height;
            canvas.width = viewport.width;

            const renderContext = {
                canvasContext: ctx,
                viewport: viewport
            };
            page.render(renderContext);
        });
    }
    
    function closePdfModal() {
        document.getElementById('pdf-modal').style.display = 'none';
    }

    // --- Existing Player Logic ---
    let videos = [];
    let currentIndex = 0;
    let loopCount = 0;
    const MAX_LOOPS = 3;
    const GROUP_SIZE = 10;
    
    // Quiz State
    let isQuizMode = false;
    let quizType = 'video'; // 'video' or 'lesson'
    let currentQuizIndex = 0;
    let quizScore = 0;
    let currentQuizQuestion = null;
    let currentQuizGroupVideos = [];
    let currentQuizLessonItems = [];
    
    const videoPlayer = document.getElementById('video-player');
    const infoDisplay = document.getElementById('current-info');
    const statusMsg = document.getElementById('status-msg');
    const groupSelector = document.getElementById('group-selector');
    const playerContainer = document.getElementById('player-container');
    const quizOverlay = document.getElementById('quiz-overlay');

    // Handle video ended event
    videoPlayer.addEventListener('ended', () => {
        if (isQuizMode) return; // Don't auto-loop in quiz mode
        
        loopCount++;
        if (loopCount < MAX_LOOPS) {
            videoPlayer.play();
            statusMsg.textContent = `ÈáçÊí≠ (${loopCount + 1}/${MAX_LOOPS})`;
        } else {
            nextVideo();
        }
    });

    // Load video list
    fetch('videos.json')
        .then(response => response.json())
        .then(data => {
            videos = data;
            initGroups();
            if (videos.length > 0) {
                loadVideo(0);
            } else {
                infoDisplay.textContent = "Êú™ÊâæÂà∞ËßÜÈ¢ë";
            }
        })
        .catch(error => {
            console.error('Error loading video list:', error);
            infoDisplay.textContent = "Âä†ËΩΩÂàóË°®Â§±Ë¥•";
        });

    function initGroups() {
        const totalGroups = Math.ceil(videos.length / GROUP_SIZE);
        groupSelector.innerHTML = '';
        for (let i = 0; i < totalGroups; i++) {
            const start = i * GROUP_SIZE + 1;
            const end = Math.min((i + 1) * GROUP_SIZE, videos.length);
            const option = document.createElement('option');
            option.value = i;
            option.textContent = `Á¨¨ ${i + 1} ÁªÑ (${start}-${end})`;
            groupSelector.appendChild(option);
        }
    }
    
    function changeGroup(groupIndex) {
        loadVideo(groupIndex * GROUP_SIZE, true);
        videoPlayer.focus();
    }

    function loadVideo(index, ignoreQuiz = false) {
        if (index < 0) index = videos.length - 1;
        if (index >= videos.length) index = 0;
        
        // Check group boundary for Quiz trigger (only when moving forward)
        if (!ignoreQuiz && index > 0 && index % GROUP_SIZE === 0 && currentIndex === index - 1) {
            startQuiz(Math.floor((index - 1) / GROUP_SIZE));
            return;
        }
        
        currentIndex = index;
        loopCount = 0; // Reset loop counter
        
        // Sync selector
        const currentGroup = Math.floor(currentIndex / GROUP_SIZE);
        groupSelector.value = currentGroup;
        
        const filename = videos[currentIndex];
        videoPlayer.src = `clips_chinese/${filename}`;
        videoPlayer.classList.remove('blur'); // Ensure no blur
        videoPlayer.play().catch(e => {
            console.log("Autoplay prevented");
            statusMsg.textContent = "ÊåâÁ©∫Ê†ºÈîÆÂºÄÂßãÊí≠Êîæ";
        });
        
        const displayName = getDisplayName(filename);
        infoDisplay.textContent = `${currentIndex + 1}/${videos.length}: ${displayName}`;
        statusMsg.textContent = `Ê≠£Âú®Êí≠Êîæ: ${displayName}`;
    }
    
    function getDisplayName(filename) {
        return filename.replace('.mp4', '').replace(/^\d+_/, '');
    }

    // --- Quiz Logic ---
    
    function startQuiz(groupIndex) {
        quizType = 'video';
        isQuizMode = true;
        playerContainer.classList.add('quiz-active'); // Keep this for CSS styling hooks if needed, though overlay is now global
        quizOverlay.style.display = 'flex'; // Show global overlay
        videoPlayer.classList.add('blur');
        videoPlayer.loop = false; 
        
        const start = groupIndex * GROUP_SIZE;
        const end = Math.min((groupIndex + 1) * GROUP_SIZE, videos.length);
        currentQuizGroupVideos = videos.slice(start, end);
        
        currentQuizIndex = 0;
        quizScore = 0;
        showQuizQuestion();
    }
    
    function startLessonQuiz(isAutoPlayTriggered = false) {
        if (!currentLessonItems || currentLessonItems.length === 0) {
            alert("Ê≤°ÊúâÂèØÁî®ÁöÑÁªÉ‰π†ÂÜÖÂÆπ");
            return;
        }
        quizType = 'lesson';
        isQuizMode = true;
        quizOverlay.style.display = 'flex';
        
        // Stop any playing video
        videoPlayer.pause();
        
        // If triggered by autoplay, we quiz ONLY the current group items
        if (isAutoPlayTriggered) {
             const start = currentLessonGroupIndex * LESSON_GROUP_SIZE;
             const end = Math.min((currentLessonGroupIndex + 1) * LESSON_GROUP_SIZE, currentLessonItems.length);
             currentQuizLessonItems = currentLessonItems.slice(start, end);
        } else {
             // Otherwise quiz all items? Or maybe just current group if user manually clicks?
             // Let's stick to current group for consistency if group selector is active
             // Actually, the "Start Quiz" button was removed in favor of "Start Learning".
             // But if we want a manual "Test Me" button, we could add it back.
             // For now, let's assume this is called mainly by autoplay or if we add a button later.
             
             // If manual button is re-added, we might want to test whole lesson or just group.
             // Given the UI change, let's default to current group as well.
             const start = currentLessonGroupIndex * LESSON_GROUP_SIZE;
             const end = Math.min((currentLessonGroupIndex + 1) * LESSON_GROUP_SIZE, currentLessonItems.length);
             currentQuizLessonItems = currentLessonItems.slice(start, end);
        }
        
        currentQuizIndex = 0;
        quizScore = 0;
        showQuizQuestion();
    }
    
    function showQuizQuestion() {
        // Clear previous state
        const questionText = document.getElementById('quiz-question-text');
        const optionsContainer = document.getElementById('quiz-options');
        const resultDiv = document.getElementById('quiz-result');
        const nextBtn = document.getElementById('quiz-next-btn');
        const closeBtn = document.getElementById('quiz-close-btn');
        const skipBtn = document.getElementById('quiz-skip-btn');
        
        // Reset UI
        optionsContainer.innerHTML = '';
        resultDiv.textContent = '';
        nextBtn.style.display = 'none';
        closeBtn.style.display = 'none';
        skipBtn.style.display = 'inline-block'; 
        
        let target, options;
        
        if (quizType === 'video') {
            const groupVideos = currentQuizGroupVideos;
            target = groupVideos[Math.floor(Math.random() * groupVideos.length)];
            options = [target];
            while (options.length < 4) {
                const random = groupVideos[Math.floor(Math.random() * groupVideos.length)];
                if (!options.includes(random)) options.push(random);
            }
            
            // Play Audio
            videoPlayer.src = `clips_chinese/${target}`;
            videoPlayer.play();
            questionText.textContent = "Âê¨ÂΩïÈü≥ÔºåÈÄâÊã©Ê≠£Á°ÆÁöÑ‰∏≠ÊñáÂê´‰πâ";
            
        } else {
            // Lesson Mode
            const items = currentQuizLessonItems;
            target = items[Math.floor(Math.random() * items.length)];
            options = [target];
            while (options.length < 4) {
                const random = items[Math.floor(Math.random() * items.length)];
                if (options.indexOf(random) === -1) options.push(random);
            }
            
            // Play TTS
            playAudio(target.thai, 'th-TH');
            questionText.textContent = "Âê¨ËØªÈü≥/ÁúãÊ≥∞ËØ≠ÔºåÈÄâÊã©Ê≠£Á°ÆÁöÑ‰∏≠ÊñáÂê´‰πâ";
            // Show Thai text in question area for lesson mode? Or just audio?
            // User said "similar rules", 100 sentences is audio only.
            // But TTS might be hard. Let's show Thai text as a hint?
            // Actually, let's show Thai text above options.
            questionText.innerHTML = `<div style="font-size:32px; color:#0070f3; margin-bottom:10px;">${target.thai}</div>Âê¨ËØªÈü≥ÔºåÈÄâÊã©Ê≠£Á°ÆÁöÑ‰∏≠ÊñáÂê´‰πâ`;
        }
        
        // Shuffle options
        options.sort(() => Math.random() - 0.5);
        
        currentQuizQuestion = {
            target: target,
            options: options
        };
        
        document.querySelector('.quiz-title').textContent = `ÊµãËØï‰∏≠ (Á¨¨ ${currentQuizIndex + 1} È¢ò)`;
        
        currentQuizQuestion.options.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'quiz-btn';
            
            if (quizType === 'video') {
                btn.textContent = getDisplayName(opt);
                btn.onclick = () => checkAnswer(btn, opt, currentQuizQuestion.target);
            } else {
                btn.textContent = opt.chinese;
                btn.onclick = () => checkAnswer(btn, opt, currentQuizQuestion.target);
            }
            
            optionsContainer.appendChild(btn);
        });
    }
    
    function checkAnswer(btn, selected, correct) {
        const buttons = document.querySelectorAll('.quiz-btn');
        buttons.forEach(b => b.disabled = true); // Disable all
        
        let isCorrect = false;
        let correctText = "";
        
        if (quizType === 'video') {
            isCorrect = selected === correct;
            correctText = getDisplayName(correct);
        } else {
            isCorrect = selected.thai === correct.thai; // Compare unique ID ideally, but Thai text works
            correctText = correct.chinese;
        }

        if (isCorrect) {
            btn.classList.add('correct');
            quizScore++;
            document.getElementById('quiz-result').textContent = "ÂõûÁ≠îÊ≠£Á°ÆÔºÅ‚úÖ";
            document.getElementById('quiz-result').style.color = "#4CAF50";
        } else {
            btn.classList.add('wrong');
            // Highlight correct one
            buttons.forEach(b => {
                if (b.textContent === correctText) {
                    b.classList.add('correct');
                }
            });
            document.getElementById('quiz-result').textContent = `ÂõûÁ≠îÈîôËØØ ‚ùå Ê≠£Á°ÆÁ≠îÊ°àÊòØ: ${correctText}`;
            document.getElementById('quiz-result').style.color = "#ef5350";
        }
        
        // Always show next button (Infinite Mode)
        const nextBtn = document.getElementById('quiz-next-btn');
        nextBtn.textContent = "ÁªßÁª≠ÊµãËØï";
        nextBtn.style.display = 'inline-block';
        
        // Update score
        document.querySelector('.quiz-title').textContent = `ÊµãËØï‰∏≠ (Á¨¨ ${currentQuizIndex + 1} È¢ò | ÂæóÂàÜ: ${quizScore})`;
    }
    
    function nextQuizQuestion() {
        currentQuizIndex++;
        if (quizType === 'lesson' && currentQuizIndex >= currentQuizLessonItems.length) {
            // Lesson Quiz Finished
            alert(`ÊµãËØïÂÆåÊàêÔºÅÂæóÂàÜ: ${quizScore}/${currentQuizLessonItems.length}`);
            closeQuiz();
            return;
        }
        showQuizQuestion();
    }
    
    function closeQuiz() {
        isQuizMode = false;
        quizOverlay.style.display = 'none';
        
        if (quizType === 'video') {
            playerContainer.classList.remove('quiz-active');
            videoPlayer.classList.remove('blur');
            
            // Resume video logic
            const currentGroup = Math.floor((currentIndex) / GROUP_SIZE);
            const nextGroupStartIndex = (currentGroup + 1) * GROUP_SIZE;
            
            if (nextGroupStartIndex < videos.length) {
                loadVideo(nextGroupStartIndex, true);
            } else {
                loadVideo(0, true); 
            }
        } else {
            // Lesson mode exit
            // Nothing special to do, just close overlay
        }
    }

    function togglePlay() {
        if (isQuizMode) {
             videoPlayer.play(); // Replay sound in quiz
             return;
        }
        if (videoPlayer.paused) {
            videoPlayer.play();
            statusMsg.textContent = "Êí≠Êîæ‰∏≠";
        } else {
            videoPlayer.pause();
            statusMsg.textContent = "Â∑≤ÊöÇÂÅú";
        }
    }

    function prevVideo() {
        if (isQuizMode) return;
        loadVideo(currentIndex - 1);
    }

    function nextVideo() {
        if (isQuizMode) return;
        loadVideo(currentIndex + 1);
    }

    // Keyboard controls
    document.addEventListener('keydown', (e) => {
        if (isQuizMode) return; // Disable keys during quiz
        switch(e.code) {
            case 'Space':
                e.preventDefault(); // Prevent scrolling
                togglePlay();
                break;
            case 'ArrowLeft':
                e.preventDefault();
                prevVideo();
                break;
            case 'ArrowRight':
                e.preventDefault();
                nextVideo();
                break;
        }
    });

    // Click on video to toggle
    videoPlayer.addEventListener('click', togglePlay);

</script>

</body>
</html>
